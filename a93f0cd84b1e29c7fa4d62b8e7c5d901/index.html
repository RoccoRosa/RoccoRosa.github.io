<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Registro Turni - Tracker Giornaliero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card {
            background: white;
            padding: 1.5rem;
            max-width: 900px;
            width: 100%;
            margin: 1rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        h1, h2, h3 {
            margin-top: 0;
        }

        .hidden {
            display: none;
        }

        .login-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="password"],
        input[type="month"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
        }

        button {
            padding: 0.5rem 0.9rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        button.primary {
            background: #2563eb;
            color: white;
        }

        button.secondary {
            background: #e5e7eb;
            color: #111827;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .user-info {
            font-size: 0.9rem;
            color: #374151;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.4rem 0.5rem;
            text-align: center;
        }

        th {
            background: #f9fafb;
        }

        .tag {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 999px;
            background: #e5e7eb;
            font-size: 0.75rem;
        }

        .status-bar {
            font-size: 0.85rem;
            color: #374151;
            margin-top: 0.5rem;
        }

        .status-bar span {
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="card">

    <!-- VISTA LOGIN -->
    <div id="login-view">
        <h1>Registro Turni</h1>
        <p style="font-size:0.9rem;color:#4b5563;margin-bottom:1rem;">
            Accedi o crea un account per registrare gli orari della tua giornata lavorativa.
        </p>

        <div class="login-group">
            <label for="username">Nome utente</label>
            <input type="text" id="username" autocomplete="username" placeholder="es. mario.rossi">
        </div>

        <div class="login-group">
            <label for="password">Password</label>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <input type="password" id="password" autocomplete="current-password" placeholder="••••••••" style="flex:1;">
                <button id="toggle-password-btn" class="secondary" type="button" style="white-space:nowrap;">Mostra</button>
            </div>
        </div>

        <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
            <button id="login-btn" class="primary">Accedi</button>
            <button id="register-btn" class="secondary">Registra nuovo account</button>
        </div>

        <p id="login-message" style="margin-top:0.75rem;font-size:0.85rem;color:#b91c1c;"></p>
    </div>

    <!-- VISTA PRINCIPALE -->
    <div id="main-view" class="hidden">
        <div class="top-bar">
            <div class="user-info">
                Utente: <span id="user-label" class="tag"></span><br>
                Oggi è <span id="today-label"></span>
            </div>
            <div class="filters">
                <div>
                    <label for="month-filter" style="font-size:0.8rem;margin-bottom:0;">Mese</label>
                    <input type="month" id="month-filter">
                </div>
                <!-- <button id="export-btn" class="secondary" title="Scarica dati come JSON">Esporta dati</button>
                <button id="sync-cred-btn" class="secondary" title="Scarica credenziali aggiornate">Scarica credenziali</button>
                <button id="import-btn" class="secondary" title="Importa dati da JSON">Importa dati</button>
                <input type="file" id="import-file" accept="application/json" class="hidden"> -->
                <button id="logout-btn" class="secondary">Esci</button>
            </div>
        </div>

        <h2>Registra orari</h2>
        <div class="btn-row">
            <button id="start-day-btn" class="primary">Inizio giornata</button>
            <button id="start-break-btn" class="secondary">Inizio pausa</button>
            <button id="end-break-btn" class="secondary">Fine pausa</button>
            <button id="end-day-btn" class="primary">Fine giornata</button>
        </div>

        <div class="status-bar" id="status-bar"></div>

        <h3 style="margin-top:1.5rem;">Riepilogo giornaliero (per mese)</h3>
        <table>
            <thead>
            <tr>
                <th>Data</th>
                <th>Inizio giornata</th>
                <th>Inizio pausa</th>
                <th>Fine pausa</th>
                <th>Fine giornata</th>
            </tr>
            </thead>
            <tbody id="log-table-body">
            <!-- Righe generate via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // Chiavi di storage
    const USERS_KEY = "workTracker_users";
    const CURRENT_USER_KEY = "workTracker_currentUser";
    const LOG_PREFIX = "workTracker_logs_";
    const DEFAULT_USERS = {
        "rocco.rosa.sft.ihz": { passwordHash: "-1161977501" } // Roccorosa2311!
    };

    // Riferimenti DOM
    const loginView = document.getElementById("login-view");
    const mainView = document.getElementById("main-view");
    const loginMsg = document.getElementById("login-message");

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const registerBtn = document.getElementById("register-btn");
    const togglePasswordBtn = document.getElementById("toggle-password-btn");

    const userLabel = document.getElementById("user-label");
    const todayLabel = document.getElementById("today-label");
    const monthFilter = document.getElementById("month-filter");
    const logoutBtn = document.getElementById("logout-btn");
    const exportBtn = document.getElementById("export-btn");
    const syncCredBtn = document.getElementById("sync-cred-btn");
    const importBtn = document.getElementById("import-btn");
    const importFileInput = document.getElementById("import-file");

    const startDayBtn = document.getElementById("start-day-btn");
    const startBreakBtn = document.getElementById("start-break-btn");
    const endBreakBtn = document.getElementById("end-break-btn");
    const endDayBtn = document.getElementById("end-day-btn");
    const statusBar = document.getElementById("status-bar");
    const tableBody = document.getElementById("log-table-body");

    let currentUser = null;

    // Utilità storage utenti
    function loadUsers() {
        const raw = localStorage.getItem(USERS_KEY);
        return raw ? JSON.parse(raw) : {};
    }

    function saveUsers(users) {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }

    function simpleHash(str) {
        // hash semplice, giusto per non salvare la password in chiaro
        let hash = 0, i, chr;
        if (str.length === 0) return hash.toString();
        for (i = 0; i < str.length; i++) {
            chr   = str.charCodeAt(i);
            hash  = ((hash << 5) - hash) + chr;
            hash |= 0;
        }
        return hash.toString();
    }

    // Utilità storage log
    function loadLogs(username) {
        const raw = localStorage.getItem(LOG_PREFIX + username);
        return raw ? JSON.parse(raw) : [];
    }

    function saveLogs(username, logs) {
        localStorage.setItem(LOG_PREFIX + username, JSON.stringify(logs));
    }

    function downloadJsonFile(filename, data) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function loadAllLogs() {
        const logs = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(LOG_PREFIX)) {
                const user = key.slice(LOG_PREFIX.length);
                try {
                    logs[user] = JSON.parse(localStorage.getItem(key)) || [];
                } catch (e) {
                    logs[user] = [];
                }
            }
        }
        return logs;
    }

    function saveAllLogs(logs) {
        Object.keys(localStorage).forEach(k => {
            if (k.startsWith(LOG_PREFIX)) localStorage.removeItem(k);
        });
        Object.entries(logs).forEach(([user, entries]) => {
            localStorage.setItem(LOG_PREFIX + user, JSON.stringify(entries || []));
        });
    }

    // Seed utenti dal file JSON locale (solo in lettura)
    async function seedUsersFromFile() {
        try {
            const existing = loadUsers();
            if (Object.keys(existing).length > 0) {
                ensureDefaultUsers();
                return; // non sovrascrivere
            }

            const res = await fetch("credentials.json", { cache: "no-store" });
            if (!res.ok) throw new Error("Impossibile caricare credentials.json");
            const data = await res.json();
            if (data && typeof data === "object" && data.users && typeof data.users === "object") {
                saveUsers(data.users);
                ensureDefaultUsers();
                return;
            }
        } catch (err) {
            console.warn(err.message || err);
        }
        // fallback a utenti di default se il file non è disponibile
        saveUsers(DEFAULT_USERS);
    }

    // Login / Registrazione
    function handleLogin(isRegister) {
        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        if (!username || !password) {
            loginMsg.textContent = "Inserisci sia nome utente che password.";
            return;
        }

        const users = loadUsers();
        const hash = simpleHash(password);

        if (isRegister) {
            if (users[username]) {
                loginMsg.textContent = "Utente già esistente. Prova ad accedere.";
                return;
            }
            users[username] = { passwordHash: hash };
            saveUsers(users);
            downloadCredentialsFile(); // scarica il file aggiornato da salvare nella cartella
            loginMsg.style.color = "#047857";
            loginMsg.textContent = "Account creato. Ora sei loggato.";
            setTimeout(() => {
                loginMsg.textContent = "";
                loginMsg.style.color = "#b91c1c";
            }, 2500);
        } else {
            if (!users[username]) {
                loginMsg.textContent = "Utente non trovato. Registrati prima.";
                return;
            }
            if (users[username].passwordHash !== hash) {
                loginMsg.textContent = "Password errata.";
                return;
            }
        }

        currentUser = username;
        localStorage.setItem(CURRENT_USER_KEY, currentUser);
        passwordInput.value = "";
        showMainView();
    }

    function showMainView() {
        loginView.classList.add("hidden");
        mainView.classList.remove("hidden");
        userLabel.textContent = currentUser;

        const today = new Date();
        todayLabel.textContent = today.toLocaleDateString("it-IT", {
            weekday: "long",
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        });

        // Set mese corrente nel filtro
        const monthVal = today.toISOString().slice(0, 7); // yyyy-MM
        monthFilter.value = monthVal;

        renderTable();
        updateStatusBar();
    }

    function showLoginView() {
        loginView.classList.remove("hidden");
        mainView.classList.add("hidden");
        loginMsg.textContent = "";
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem(CURRENT_USER_KEY);
        showLoginView();
    }

    // Gestione eventi giornata
    function recordEvent(type) {
        if (!currentUser) return;

        const now = new Date();
        const logs = loadLogs(currentUser);

        const todayKey = now.toISOString().slice(0, 10); // yyyy-MM-dd
        const already = logs.some(e => e.type === type && e.timestamp.slice(0,10) === todayKey);

        if (already) {
            alert("Evento \"" + labelForType(type) + "\" già registrato per oggi.");
            return;
        }

        logs.push({
            type,
            timestamp: now.toISOString()
        });

        saveLogs(currentUser, logs);
        renderTable();
        updateStatusBar();
    }

    function labelForType(type) {
        switch (type) {
            case "startDay": return "Inizio giornata";
            case "startBreak": return "Inizio pausa";
            case "endBreak": return "Fine pausa";
            case "endDay": return "Fine giornata";
            default: return type;
        }
    }

    function ensureDefaultUsers() {
        const users = loadUsers();
        let changed = false;
        Object.entries(DEFAULT_USERS).forEach(([user, data]) => {
            if (!users[user]) {
                users[user] = data;
                changed = true;
            }
        });
        if (changed) saveUsers(users);
    }

    function updateStatusBar() {
        if (!currentUser) return;

        const logs = loadLogs(currentUser);
        const todayKey = new Date().toISOString().slice(0,10);
        const todayEvents = logs.filter(e => e.timestamp.slice(0,10) === todayKey);

        if (todayEvents.length === 0) {
            statusBar.textContent = "Nessun evento registrato per oggi.";
            return;
        }

        const parts = [];
        ["startDay","startBreak","endBreak","endDay"].forEach(type => {
            const ev = todayEvents.find(e => e.type === type);
            if (ev) {
                const time = new Date(ev.timestamp).toLocaleTimeString("it-IT", {
                    hour: "2-digit",
                    minute: "2-digit"
                });
                parts.push(labelForType(type) + ": " + time);
            }
        });

        statusBar.innerHTML = "Oggi &rarr; " + parts.join(" | ");
    }

    // Render tabella per mese selezionato
    function renderTable() {
        if (!currentUser) return;
        const logs = loadLogs(currentUser).sort((a,b) => a.timestamp.localeCompare(b.timestamp));

        const monthVal = monthFilter.value; // yyyy-MM
        tableBody.innerHTML = "";

        if (!monthVal) return;

        const perDay = {};

        logs.forEach(entry => {
            const dateStr = entry.timestamp.slice(0,10); // yyyy-MM-dd
            if (!dateStr.startsWith(monthVal)) return;

            if (!perDay[dateStr]) {
                perDay[dateStr] = {
                    startDay: null,
                    startBreak: null,
                    endBreak: null,
                    endDay: null
                };
            }

            if (!perDay[dateStr][entry.type]) {
                perDay[dateStr][entry.type] = entry.timestamp;
            }
        });

        const days = Object.keys(perDay).sort().reverse(); // ultimi giorni in alto

        if (days.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 5;
            td.textContent = "Nessun dato per il mese selezionato.";
            tr.appendChild(td);
            tableBody.appendChild(tr);
            return;
        }

        days.forEach(d => {
            const data = perDay[d];
            const tr = document.createElement("tr");

            const dateCell = document.createElement("td");
            const dt = new Date(d + "T00:00:00");
            dateCell.textContent = dt.toLocaleDateString("it-IT");
            tr.appendChild(dateCell);

            ["startDay","startBreak","endBreak","endDay"].forEach(type => {
                const td = document.createElement("td");
                if (data[type]) {
                    const t = new Date(data[type]).toLocaleTimeString("it-IT", {
                        hour: "2-digit",
                        minute: "2-digit"
                    });
                    td.textContent = t;
                } else {
                    td.textContent = "-";
                }
                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    // Import / Export
    function exportData() {
        const payload = {
            users: loadUsers(),
            logs: loadAllLogs(),
            currentUser
        };
        downloadJsonFile("worktracker-data-" + new Date().toISOString().slice(0,10) + ".json", payload);
    }

    function downloadCredentialsFile() {
        const payload = {
            users: loadUsers(),
            note: "Sostituisci questo file nella cartella del sito per condividere le credenziali sugli altri dispositivi. In scrittura il browser non puo aggiornare il file automaticamente."
        };
        downloadJsonFile("credentials.json", payload);
    }

    function handleImportFile(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            try {
                const parsed = JSON.parse(reader.result);
                if (typeof parsed !== "object" || parsed === null) throw new Error("File non valido");
                const users = parsed.users && typeof parsed.users === "object" ? parsed.users : {};
                const logs = parsed.logs && typeof parsed.logs === "object" ? parsed.logs : {};
                saveUsers(users);
                saveAllLogs(logs);

                if (parsed.currentUser && users[parsed.currentUser]) {
                    currentUser = parsed.currentUser;
                    localStorage.setItem(CURRENT_USER_KEY, currentUser);
                    showMainView();
                } else {
                    currentUser = null;
                    localStorage.removeItem(CURRENT_USER_KEY);
                    showLoginView();
                }
                alert("Dati importati con successo.");
            } catch (err) {
                alert("Import fallito: " + err.message);
            } finally {
                importFileInput.value = "";
            }
        };
        reader.readAsText(file);
    }

    // Event listeners
    loginBtn.addEventListener("click", () => handleLogin(false));
    registerBtn.addEventListener("click", () => handleLogin(true));
    logoutBtn.addEventListener("click", logout);
    togglePasswordBtn.addEventListener("click", () => {
        const isHidden = passwordInput.type === "password";
        passwordInput.type = isHidden ? "text" : "password";
        togglePasswordBtn.textContent = isHidden ? "Nascondi" : "Mostra";
    });

    startDayBtn.addEventListener("click", () => recordEvent("startDay"));
    startBreakBtn.addEventListener("click", () => recordEvent("startBreak"));
    endBreakBtn.addEventListener("click", () => recordEvent("endBreak"));
    endDayBtn.addEventListener("click", () => recordEvent("endDay"));

    monthFilter.addEventListener("change", renderTable);
    exportBtn.addEventListener("click", exportData);
    syncCredBtn.addEventListener("click", downloadCredentialsFile);
    importBtn.addEventListener("click", () => importFileInput.click());
    importFileInput.addEventListener("change", handleImportFile);

    // Auto-login se c'è utente salvato
    window.addEventListener("DOMContentLoaded", async () => {
        await seedUsersFromFile();
        ensureDefaultUsers();
        const savedUser = localStorage.getItem(CURRENT_USER_KEY);
        if (savedUser) {
            currentUser = savedUser;
            showMainView();
        } else {
            showLoginView();
        }
    });
</script>
</body>
</html>
